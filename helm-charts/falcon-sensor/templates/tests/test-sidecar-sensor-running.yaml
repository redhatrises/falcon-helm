{{- if .Values.container.enabled }}
---
apiVersion: v1
kind: Namespace
metadata:
  name: nginx
  namespace: nginx
---
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "falcon-sensor.fullname" . }}-test-sidecar-sensor-running"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "falcon-sensor.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
    - name: kubectl
      image: docker.io/bitnami/kubectl
      command:
      - /bin/sh
      - -c
      - |
        echo "Waiting 10 seconds to allow pod time to initialize before running test"
        sleep 10
        KUBECMD=$(kubectl get pods -n "{{ .Release.Namespace }}" -l "app.kubernetes.io/component=container_sensor" --field-selector=status.phase!=Running --no-headers 2>&1)
        if ! echo "${KUBECMD}" | grep -q "No resources found"; then
            echo "[\033[0;31mFAIL\033[0m]: Injector pod is NOT running"
            echo "${KUBECMD}"
            exit 1
        else
            echo "[\033[0;32mOK\033[0m]: Injector pod is running"

            echo "Running test pod to verify sidecar injection"
            kubectl run nginx -n nginx --image=nginx --restart=Never

            echo "Waiting 10 seconds to allow pod time to initialize before running test"
            sleep 30
            kubectl get pods -n nginx
            kubectl get events -n nginx
            kubectl describe pods -n nginx
            kubectl get pods -n nginx -o jsonpath="{.items[*].spec.containers[*].name} {.items[*].status.containerStatuses[*].state}"
            exit 0
        fi
      securityContext:
        runAsUser: 0
        privileged: true
        readOnlyRootFilesystem: false
        allowPrivilegeEscalation: true
  serviceAccountName: {{ .Values.serviceAccount.name }}
  restartPolicy: Never
{{- end -}}
